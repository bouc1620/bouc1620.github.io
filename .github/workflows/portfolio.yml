name: Portfolio

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Generate projects.json
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const repos = (await github.paginate(
              github.rest.repos.listForUser,
              { username: 'bouc1620', per_page: 100 }
            )).filter((repo) => repo.topics.includes('portfolio'));

            const getRepoMetadata = async (repo) => {
              try {
                const file = await github.rest.repos.getContent({
                  owner: 'bouc1620',
                  repo: repo.name,
                  path: "portfolio.i18n.json"
                });

                const content = Buffer.from(
                  file.data.content,
                  "base64"
                ).toString("utf8");

                return JSON.parse(content);
              } catch {
                return {
                  description: {
                    'fr': repo.description,
                    'en': repo.description
                  },
                  keywords: [],
                  languages: [
                    repo.language
                  ],
                };
              }
            };

            const projects = [];

            for (const repo of repos) {
              projects.push({
                name: repo.name,
                url: repo.html_url,
                stars: repo.stargazers_count,
                ...(await getRepoMetadata(repo)),
              });
            }

            fs.writeFileSync(
              "src/i18n/projects.json",
              JSON.stringify(projects, null, 2)
            );

      - name: Commit generated file via API
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'src/i18n/projects.json';
            const content = fs.readFileSync(path, 'utf8');

            try {
              const { data: file } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path,
              });

              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path,
                message: 'Update projects.json',
                content: Buffer.from(content).toString('base64'),
                sha: file.sha,
              });
            } catch {
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path,
                message: 'Add projects.json',
                content: Buffer.from(content).toString('base64'),
              });
            }
