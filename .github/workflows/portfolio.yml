name: Portfolio

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 0 * * 0'

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Generate projects.json
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");

            const query = `
              query {
                user(login: "bouc1620") {
                  pinnedItems(first: 6, types: REPOSITORY) {
                    edges {
                      node {
                        ... on Repository {
                          name
                          description
                          url
                          stargazerCount
                          primaryLanguage { name }
                          repositoryTopics(first: 10) {
                            nodes { topic { name } }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query);

            const pinnedRepos = result.user.pinnedItems.edges
              .map(e => e.node)
              .filter(repo => repo.repositoryTopics.nodes.some(t => t.topic.name === "portfolio"));

            const getRepoMetadata = async (repo) => {
              try {
                const file = await github.rest.repos.getContent({
                  owner: "bouc1620",
                  repo: repo.name,
                  path: "portfolio.i18n.json"
                });
                const content = Buffer.from(file.data.content, "base64").toString("utf8");
                return JSON.parse(content);
              } catch {
                return {
                  description: { fr: repo.description, en: repo.description },
                  keywords: [],
                  languages: [repo.primaryLanguage?.name || null],
                };
              }
            };

            const projects = [];
            for (const repo of pinnedRepos) {
              projects.push({
                name: repo.name,
                url: repo.url,
                stars: repo.stargazerCount,
                ...(await getRepoMetadata(repo)),
              });
            }

            fs.writeFileSync("src/i18n/projects.json", JSON.stringify(projects, null, 2));

      - name: Commit projects.json if changed
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Update projects.json'
          branch: main
          commit_user_name: 'GitHub Actions'
          commit_user_email: 'actions@github.com'

      - name: Build site
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
