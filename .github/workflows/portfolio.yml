name: Portfolio

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  build:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Generate projects.json
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const query = `
              query {
                user(login: "bouc1620") {
                  pinnedItems(first: 6, types: REPOSITORY) {
                    edges {
                      node {
                        ... on Repository {
                          name
                          description
                          url
                          stargazerCount
                          primaryLanguage { name }
                          repositoryTopics(first: 10) {
                            nodes { topic { name } }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query);
            const pinnedRepos = result.user.pinnedItems.edges
              .map(e => e.node)
              .filter(repo => repo.repositoryTopics.nodes.some(t => t.topic.name === "portfolio"));

            const getRepoMetadata = async (repo) => {
              try {
                const file = await github.rest.repos.getContent({
                  owner: "bouc1620",
                  repo: repo.name,
                  path: "portfolio.i18n.json"
                });
                const content = Buffer.from(file.data.content, "base64").toString("utf8");
                return JSON.parse(content);
              } catch {
                return {
                  description: { fr: repo.description, en: repo.description },
                  keywords: [],
                  languages: [repo.primaryLanguage?.name || null],
                };
              }
            };

            const projects = [];
            for (const repo of pinnedRepos) {
              projects.push({
                name: repo.name,
                url: repo.url,
                stars: repo.stargazerCount,
                ...(await getRepoMetadata(repo)),
              });
            }

            fs.writeFileSync(
              "src/i18n/projects.json",
              JSON.stringify(projects, null, 2)
            );

      - name: Commit via API
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const fs = require('fs');
            const path = 'src/i18n/projects.json';
            const content = fs.readFileSync(path, 'utf8');

            try {
              const { data: file } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path,
              });

              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path,
                message: 'Update projects.json',
                content: Buffer.from(content).toString('base64'),
                sha: file.sha,
              });
            } catch {
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path,
                message: 'Add projects.json',
                content: Buffer.from(content).toString('base64'),
              });
            }
